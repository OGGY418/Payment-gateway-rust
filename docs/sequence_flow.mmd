# End-to-End Flow (Happy Path)
# docs/sequence_flow.mmd

USER / MERCHANT
    â”‚
    â”‚ 1. Open QR UI (payment.html)
    â–¼
FRONTEND (QR UI)
    â”‚
    â”‚ 2. POST /payments/create
    â”‚    - amount_lamports
    â”‚    - order_id (optional)
    â”‚    - customer_email (optional)
    â–¼
API SERVER (Axum)
    â”‚
    â”‚ 3. Generate memo: PAY_<random>
    â”‚ 4. Insert row into `payments` table:
    â”‚      - id (UUID)
    â”‚      - amount_lamports
    â”‚      - memo
    â”‚      - status = "pending"
    â”‚      - receiver_address = MERCHANT_ADDRESS
    â”‚      - created_at, expires_at (5 min)
    â”‚ 5. Return JSON:
    â”‚      { payment_id, memo, amount_lamports, receiver_address,
    â”‚        status, solana_pay_url }
    â–¼
FRONTEND (QR UI)
    â”‚
    â”‚ 6. Generate Solana Pay URL:
    â”‚      solana:<receiver>?amount=<amount>&memo=<memo>&label=<order>
    â”‚ 7. Render QR code
    â–¼
CUSTOMER WALLET (PHANTOM / SOLFLARE)
    â”‚
    â”‚ 8. User scans QR
    â”‚ 9. Wallet builds tx:
    â”‚      - transfer SOL â†’ receiver_address
    â”‚      - attach MEMO instruction = memo
    â”‚10. User approves transaction
    â–¼
SOLANA CHAIN / RPC
    â”‚
    â”‚11. Transaction is confirmed on devnet
    â–¼
INDEXER SERVICE
    â”‚
    â”‚12. Periodically:
    â”‚      a) getSignaturesForAddress(merchant)
    â”‚      b) for each new signature:
    â”‚           - getTransaction(signature)
    â”‚           - extract MEMO from logs
    â”‚           - extract transfer amount â†’ lamports
    â”‚13. Look up DB: payments.memo == extracted memo AND status="pending"
    â”‚14. If match found:
    â”‚      - update row:
    â”‚          status     = "confirmed"
    â”‚          sender     = from_address
    â”‚          tx_sig     = signature
    â”‚          paid_at    = NOW()
    â”‚      - optionally push a job into Redis
    â–¼
WORKER SERVICE (REDIS CONSUMER)
    â”‚
    â”‚15. Dequeue payment job
    â”‚16. Run any extra processing:
    â”‚      - send webhook / notification
    â”‚      - update analytics
    â”‚17. Mark job as completed
    â–¼
FRONTEND / MERCHANT PANEL
    â”‚
    â”‚18. Poll /payments/:id
    â”‚19. Show status:
    â”‚      "pending" â†’ "confirmed" or "expired"
    â–¼
USER SEES
    - âœ… Payment confirmed
    - or ğŸ•’ Waitingâ€¦ / âŒ expired (if no tx within 5 min)

